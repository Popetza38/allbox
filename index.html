<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AOT User Management Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="min-h-screen bg-slate-50 p-4 md:p-8 text-slate-900">

    <div id="app" class="max-w-full mx-auto">
        <div class="mb-6 text-center">
            <h1 class="text-3xl font-bold text-slate-800 mb-2 flex items-center justify-center gap-2">
                <i data-lucide="building-2" class="text-blue-600"></i> AOT User Management Tool
            </h1>
            <p class="text-slate-600 font-medium italic underline decoration-blue-200">
                แยกชื่อและกำหนดข้อมูลบริษัทอัตโนมัติ (Excel 8 คอลัมน์)
            </p>
        </div>

        <div class="mb-6 bg-white p-6 rounded-2xl shadow-sm border border-blue-100">
            <div class="flex items-center gap-2 mb-4 text-blue-700 font-bold border-b border-blue-50 pb-2">
                <i data-lucide="settings-2" size="20"></i>
                <h2>ตั้งค่าข้อมูล (Dropdown Settings)</h2>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="space-y-2">
                    <label class="text-xs font-bold text-slate-500 uppercase flex items-center gap-1">
                        <i data-lucide="file-text" size="14"></i> Description
                    </label>
                    <select id="descConfig" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-500 transition-all"></select>
                </div>
                <div class="space-y-2">
                    <label class="text-xs font-bold text-slate-500 uppercase flex items-center gap-1">
                        <i data-lucide="building-2" size="14"></i> Company / Authority
                    </label>
                    <select id="compConfig" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-500 transition-all"></select>
                </div>
                <div class="space-y-2">
                    <label class="text-xs font-bold text-slate-500 uppercase flex items-center gap-1">
                        <i data-lucide="users" size="14"></i> Group Name
                    </label>
                    <select id="groupConfig" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-500 transition-all"></select>
                </div>
            </div>
        </div>

        <div id="errorMessage" class="hidden mb-6 p-4 bg-red-50 border border-red-200 rounded-xl flex items-center gap-3 text-red-700 max-w-2xl mx-auto">
            <i data-lucide="alert-circle"></i>
            <p id="errorText" class="text-sm font-medium"></p>
        </div>

        <div class="grid grid-cols-1 xl:grid-cols-12 gap-6">
            <div class="xl:col-span-4 bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold flex items-center gap-2 text-slate-700">
                        <i data-lucide="file-text" class="text-blue-500"></i> ข้อมูลนำเข้า
                    </h2>
                    <div class="flex gap-2">
                        <label class="cursor-pointer bg-blue-50 hover:bg-blue-100 text-blue-600 px-3 py-1.5 rounded-lg text-sm font-medium transition-colors flex items-center gap-1 border border-blue-100">
                            <i data-lucide="upload" size="16"></i>
                            เลือกไฟล์
                            <input type="file" id="fileInput" accept=".csv,.xlsx,.xls,.txt" class="hidden">
                        </label>
                        <button onclick="clearAll()" class="text-slate-400 hover:text-red-500 transition-colors">
                            <i data-lucide="trash-2"></i>
                        </button>
                    </div>
                </div>
                
                <textarea id="inputText" class="w-full h-80 p-4 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none resize-none text-xs mb-4 bg-slate-50/30 font-mono" placeholder="วางข้อมูลที่นี่... (A=Login, B=Name)"></textarea>

                <button onclick="handleProcess()" id="processBtn" class="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold shadow-lg transition-all flex items-center justify-center gap-2 active:scale-95">
                    <i data-lucide="play" size="20" fill="currentColor"></i> ประมวลผลและใช้การตั้งค่า
                </button>
            </div>

            <div class="xl:col-span-8 bg-white p-6 rounded-2xl shadow-sm border border-slate-200 flex flex-col h-[560px]">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold flex items-center gap-2 text-slate-700">
                        <i data-lucide="check-circle-2" class="text-green-500"></i> ผลลัพธ์
                    </h2>
                    <button id="downloadBtn" onclick="downloadExcel()" class="hidden bg-green-600 hover:bg-green-700 text-white px-4 py-1.5 rounded-lg text-sm font-bold shadow-sm flex items-center gap-2">
                        <i data-lucide="download" size="16"></i> Export Excel
                    </button>
                </div>

                <div id="tableContainer" class="hidden overflow-auto border border-slate-100 rounded-xl flex-grow shadow-inner custom-scrollbar">
                    <table class="w-full text-left text-[10px] border-collapse min-w-[1000px]">
                        <thead class="bg-slate-100 sticky top-0 z-10 font-bold text-slate-700">
                            <tr>
                                <th class="p-2 border-b">Login name</th>
                                <th class="p-2 border-b">First name</th>
                                <th class="p-2 border-b">Last name</th>
                                <th class="p-2 border-b">Description</th>
                                <th class="p-2 border-b">Password</th>
                                <th class="p-2 border-b">Repeat pwd</th>
                                <th class="p-2 border-b">Company</th>
                                <th class="p-2 border-b">Group</th>
                            </tr>
                        </thead>
                        <tbody id="resultBody"></tbody>
                    </table>
                </div>

                <div id="emptyState" class="flex-grow flex flex-col items-center justify-center text-slate-400 border-2 border-dashed border-slate-100 rounded-xl bg-slate-50/50">
                    <i data-lucide="users" size="48" class="mb-3 opacity-20"></i>
                    <p>ตารางจะแสดงผลข้อมูลตามที่คุณตั้งค่าไว้</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data Options
        const DESCRIPTION_OPTIONS = ["AOT Screening Operator", "AOT AVSEC", "AOT Inspectors Operator", "AOT Inspectors Service", "AOT Supervisor", "AOT Technician", "T.T.S Service"];
        const COMPANY_OPTIONS = ["AOT BKK", "T.T.S.", "AOT AVSEC", "Smiths Heimann"];
        const titlesList = ['MASTER', 'SGT', 'LT', 'MAJOR', 'COL', 'CAPT', 'REV', 'MDM', 'MADAM', 'SIR', 'PROF', 'DR', 'MISS', 'MS', 'MR', 'MRS'];

        let processedResults = [];

        // Initialize UI
        function init() {
            const populateSelect = (id, options) => {
                const select = document.getElementById(id);
                options.forEach(opt => {
                    const el = document.createElement('option');
                    el.value = el.textContent = opt;
                    select.appendChild(el);
                });
            };
            populateSelect('descConfig', DESCRIPTION_OPTIONS);
            populateSelect('compConfig', COMPANY_OPTIONS);
            populateSelect('groupConfig', DESCRIPTION_OPTIONS);
            lucide.createIcons();
        }

        // Split Name Logic
        function splitName(fullName) {
            if (!fullName) return { firstName: '', lastName: '' };
            let cleanName = fullName.trim();
            let title = "";
            let lastName = "";

            const titleRegex = new RegExp(`^(${titlesList.join('|')})(\\.?\\s*|\\s+|$)`, 'i');
            const match = cleanName.match(titleRegex);

            let remainingPart = cleanName;
            if (match) {
                title = match[1].toUpperCase();
                if (title !== 'MISS' && !title.endsWith('.')) title += '.';
                remainingPart = cleanName.substring(match[0].length).trim();
            }

            const parts = remainingPart.split(/\s+/).filter(p => p.length > 0);
            let firstName = parts[0] || "";
            if (parts.length >= 2) lastName = parts.slice(1).join(' ');

            return {
                firstName: title ? `${title} ${firstName.toUpperCase()}`.trim() : firstName.toUpperCase(),
                lastName: lastName.toUpperCase()
            };
        }

        // Process Data
        function handleProcess() {
            const text = document.getElementById('inputText').value;
            if (!text.trim()) return;

            const config = {
                description: document.getElementById('descConfig').value,
                company: document.getElementById('compConfig').value,
                groupName: document.getElementById('groupConfig').value
            };

            try {
                const lines = text.split('\n').filter(line => line.trim() !== '');
                processedResults = lines.map(line => {
                    let loginName = "", fullNamePart = "";
                    if (line.includes(',')) {
                        const cols = line.split(',');
                        loginName = cols[0].trim();
                        fullNamePart = (cols[1] || '').trim();
                        if (/name|รหัส|login/i.test(loginName)) return null;
                    } else {
                        fullNamePart = line.trim();
                    }

                    if (!fullNamePart && !loginName) return null;
                    const splitData = splitName(fullNamePart);
                    const pwd = loginName ? `${loginName}0` : "";

                    return { loginName, ...splitData, ...config, password: pwd };
                }).filter(Boolean);

                renderTable();
            } catch (err) {
                showError("เกิดข้อผิดพลาดในการประมวลผล");
            }
        }

        function renderTable() {
            const body = document.getElementById('resultBody');
            body.innerHTML = '';
            processedResults.forEach(res => {
                const row = `
                    <tr class="hover:bg-blue-50/50 border-b border-slate-50">
                        <td class="p-2 border-r font-mono">${res.loginName}</td>
                        <td class="p-2 border-r text-blue-700 font-bold">${res.firstName}</td>
                        <td class="p-2 border-r text-slate-500">${res.lastName}</td>
                        <td class="p-2 border-r">${res.description}</td>
                        <td class="p-2 border-r text-orange-600 font-mono">${res.password}</td>
                        <td class="p-2 border-r text-orange-600 font-mono">${res.password}</td>
                        <td class="p-2 border-r">${res.company}</td>
                        <td class="p-2">${res.groupName}</td>
                    </tr>`;
                body.insertAdjacentHTML('beforeend', row);
            });

            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('tableContainer').classList.remove('hidden');
            document.getElementById('downloadBtn').classList.remove('hidden');
        }

        // File Upload
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            
            if (file.name.match(/\.(xlsx|xls)$/)) {
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const wb = XLSX.read(data, {type: 'array'});
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(ws, {header: 1});
                    document.getElementById('inputText').value = rows.map(r => r.join(',')).join('\n');
                };
                reader.readAsArrayBuffer(file);
            } else {
                reader.onload = (e) => document.getElementById('inputText').value = e.target.result;
                reader.readAsText(file);
            }
        });

        // Export Excel
        function downloadExcel() {
            const data = [
                ["Login name", "First name", "Last name", "Description", "Password", "Repeat password", "First Name of company / authority", "Group name"],
                ...processedResults.map(r => [r.loginName, r.firstName, r.lastName, r.description, r.password, r.password, r.company, r.groupName])
            ];
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Users");
            XLSX.writeFile(wb, `aot_import_${new Date().getTime()}.xlsx`);
        }

        function clearAll() {
            document.getElementById('inputText').value = '';
            document.getElementById('resultBody').innerHTML = '';
            document.getElementById('tableContainer').classList.add('hidden');
            document.getElementById('downloadBtn').classList.add('hidden');
            document.getElementById('emptyState').classList.remove('hidden');
        }

        function showError(msg) {
            const err = document.getElementById('errorMessage');
            document.getElementById('errorText').textContent = msg;
            err.classList.remove('hidden');
            setTimeout(() => err.classList.add('hidden'), 3000);
        }

        init();
    </script>
</body>
</html>
