<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0a0a0a">
    <title>à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£à¸”à¸¹ - DramaBox</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Niramit:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <header class="header scrolled">
        <div class="header-container">
            <a href="/" class="logo">ğŸ¬ Drama<span>Box</span></a>
            <h2 style="flex:1;font-size:1.2rem;font-weight:600" data-i18n="watchHistory">ğŸ“œ à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£à¸”à¸¹</h2>
            <select id="langSelect" class="lang-selector">
                <option value="th">ğŸ‡¹ğŸ‡­ à¹„à¸—à¸¢</option>
                <option value="en">ğŸ‡ºğŸ‡¸ English</option>
            </select>
        </div>
    </header>

    <main class="main-content">
        <div class="container">
            <div class="row-header" style="margin-bottom:24px">
                <h2 class="row-title" data-i18n="watchHistory">ğŸ“œ à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£à¸”à¸¹</h2>
                <button class="btn btn-secondary" onclick="clearAllHistory()" style="padding:10px 18px;font-size:.9rem">
                    ğŸ—‘ï¸ <span data-i18n="clearHistory">à¸¥à¹‰à¸²à¸‡à¸›à¸£à¸°à¸§à¸±à¸•à¸´</span>
                </button>
            </div>
            <div id="historyList" class="history-list"></div>
        </div>
    </main>

    <nav class="bottom-nav">
        <a href="/" class="nav-item"><span class="icon">ğŸ </span><span class="label"
                data-i18n="home">à¸«à¸™à¹‰à¸²à¸«à¸¥à¸±à¸</span></a>
        <a href="#" class="nav-item"><span class="icon">ğŸ”</span><span class="label" data-i18n="search">à¸„à¹‰à¸™à¸«à¸²</span></a>
        <a href="history" class="nav-item active"><span class="icon">ğŸ“œ</span><span class="label"
                data-i18n="history">à¸›à¸£à¸°à¸§à¸±à¸•à¸´</span></a>
        <a href="#" class="nav-item"><span class="icon">ğŸ‘¤</span><span class="label"
                data-i18n="profile">à¹‚à¸›à¸£à¹„à¸Ÿà¸¥à¹Œ</span></a>
    </nav>

    <script src="js/i18n.js"></script>
    <script src="js/history.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            initLang();
            updateUIText();
            renderHistory();
            watchHistory.onChange(renderHistory);
            i18n.onLanguageChange(() => { updateUIText(); renderHistory(); });
        });

        function initLang() {
            const s = document.getElementById('langSelect');
            s.value = i18n.getLanguage();
            s.addEventListener('change', e => i18n.setLanguage(e.target.value));
        }

        function updateUIText() {
            document.querySelectorAll('[data-i18n]').forEach(el => el.textContent = i18n.t(el.dataset.i18n));
        }

        function renderHistory() {
            const container = document.getElementById('historyList');
            const items = watchHistory.getAll();

            if (items.length === 0) {
                container.innerHTML = `
          <div class="empty-state slide-up">
            <div class="empty-icon">ğŸ“º</div>
            <h3 class="empty-title">${i18n.t('noHistory')}</h3>
            <p class="empty-description">${i18n.t('noHistoryDesc')}</p>
            <a href="/" class="btn btn-primary">ğŸ  ${i18n.t('home')}</a>
          </div>
        `;
                return;
            }

            container.innerHTML = items.map(item => {
                const percent = watchHistory.getProgressPercent(item);
                const time = i18n.formatRelativeTime(item.lastWatched);
                return `
          <div class="history-item" onclick="continueWatch('${item.bookId}', ${item.episodeIndex})">
            <div class="history-poster">
              <img src="${item.coverUrl}" alt="${item.bookName}" loading="lazy" 
                   onerror="this.src='https://placehold.co/200x300/1c1c1c/666?text=No+Image'">
            </div>
            <div class="history-info">
              <h3 class="history-title">${item.bookName}</h3>
              <p class="history-episode">${item.episodeName} â€¢ ${item.episodeIndex + 1}/${item.totalEpisodes}</p>
              <div class="history-progress-bar"><div class="history-progress-fill" style="width:${percent}%"></div></div>
              <p class="history-time">${i18n.t('watchedPercent')}: ${percent}% â€¢ ${time}</p>
            </div>
            <div class="history-delete" onclick="event.stopPropagation();removeItem('${item.bookId}')">ğŸ—‘ï¸</div>
          </div>
        `;
            }).join('');
        }

        function continueWatch(bookId, epIdx) {
            location.href = `watch?id=${bookId}&ep=${epIdx}`;
        }

        function removeItem(bookId) {
            Swal.fire({
                title: i18n.t('confirm'),
                text: 'à¸¥à¸šà¸£à¸²à¸¢à¸à¸²à¸£à¸™à¸µà¹‰à¸­à¸­à¸à¸ˆà¸²à¸à¸›à¸£à¸°à¸§à¸±à¸•à¸´?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#e50914',
                cancelButtonColor: '#333',
                confirmButtonText: i18n.t('confirm'),
                cancelButtonText: i18n.t('cancel'),
                background: '#181818',
                color: '#fff'
            }).then(r => {
                if (r.isConfirmed) {
                    watchHistory.remove(bookId);
                    Swal.fire({ icon: 'success', title: i18n.t('success'), timer: 1500, showConfirmButton: false, background: '#181818', color: '#fff' });
                }
            });
        }

        function clearAllHistory() {
            Swal.fire({
                title: i18n.t('confirmClearHistory'),
                text: i18n.t('confirmClearHistoryText'),
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#e50914',
                cancelButtonColor: '#333',
                confirmButtonText: i18n.t('confirm'),
                cancelButtonText: i18n.t('cancel'),
                background: '#181818',
                color: '#fff'
            }).then(r => {
                if (r.isConfirmed) {
                    watchHistory.clear();
                    Swal.fire({ icon: 'success', title: i18n.t('historyCleared'), timer: 1500, showConfirmButton: false, background: '#181818', color: '#fff' });
                }
            });
        }
    </script>
</body>

</html>