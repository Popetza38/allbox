<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0a0a0a">
    <title>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î - DramaBox</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Niramit:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <!-- Header -->
    <header class="header scrolled">
        <div class="header-container">
            <a href="/" class="logo">üé¨ Drama<span>Box</span></a>
            <div class="search-box">
                <input type="text" id="searchInput" class="search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ã‡∏µ‡∏£‡∏µ‡πà‡∏¢‡πå...">
                <button class="search-btn" onclick="searchFromDetail()">üîç</button>
            </div>
            <select id="langSelect" class="lang-selector">
                <option value="th">üáπüá≠ ‡πÑ‡∏ó‡∏¢</option>
                <option value="en">üá∫üá∏ English</option>
            </select>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content" style="padding-top:0">
        <section class="detail-hero" id="detailHero">
            <div class="detail-backdrop">
                <img id="backdropImage" src="" alt="">
            </div>
        </section>

        <div class="detail-content" id="detailContent">
            <div class="detail-poster">
                <img id="posterImage" src="" alt="">
            </div>
            <div class="detail-info">
                <h1 class="detail-title" id="dramaTitle">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</h1>
                <div class="detail-meta" id="dramaMeta"></div>
                <p class="detail-description" id="dramaDescription"></p>
                <div class="detail-actions">
                    <button class="btn btn-primary" id="playBtn" onclick="playFromStart()">
                        ‚ñ∂Ô∏è <span data-i18n="watchNow">‡∏î‡∏π‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</span>
                    </button>
                    <button class="btn btn-secondary" onclick="shareDrama()">
                        üì§ <span data-i18n="share">‡πÅ‡∏ä‡∏£‡πå</span>
                    </button>
                </div>
            </div>
        </div>

        <section class="episode-section" id="episodeSection">
            <div class="episode-header">
                <h2 class="episode-title" data-i18n="episodes">‡∏ï‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
                <span class="episode-count" id="episodeCount"></span>
            </div>
            <div class="episode-grid" id="episodeGrid"></div>
        </section>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="/" class="nav-item"><span class="icon">üè†</span><span class="label">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span></a>
        <a href="#" class="nav-item"><span class="icon">üîç</span><span class="label">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</span></a>
        <a href="history" class="nav-item"><span class="icon">üìú</span><span class="label">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</span></a>
        <a href="#" class="nav-item"><span class="icon">üë§</span><span class="label">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</span></a>
    </nav>

    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="spinner"></div>
        <p class="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
    </div>

    <script src="js/i18n.js"></script>
    <script src="js/history.js"></script>
    <script src="js/api.js"></script>
    <script>
        let currentDrama = null, episodes = [];

        document.addEventListener('DOMContentLoaded', () => {
            initLang();
            updateUIText();
            loadDramaDetail();
            i18n.onLanguageChange(() => { updateUIText(); api.clearCache(); loadDramaDetail(); });
        });

        function initLang() {
            const s = document.getElementById('langSelect');
            s.value = i18n.getLanguage();
            s.addEventListener('change', e => i18n.setLanguage(e.target.value));
        }

        function updateUIText() {
            document.querySelectorAll('[data-i18n]').forEach(el => el.textContent = i18n.t(el.dataset.i18n));
        }

        async function loadDramaDetail() {
            const bookId = new URLSearchParams(location.search).get('id');
            if (!bookId) return showError(i18n.t('notFound'));
            showLoading();
            try {
                currentDrama = await api.getDetail(bookId);
                if (!currentDrama) throw new Error(i18n.t('notFound'));

                document.title = currentDrama.bookName + ' - DramaBox';
                document.getElementById('backdropImage').src = currentDrama.coverUrl;
                document.getElementById('posterImage').src = currentDrama.coverUrl;
                document.getElementById('dramaTitle').textContent = currentDrama.bookName;
                document.getElementById('dramaDescription').textContent = currentDrama.description || '';
                document.getElementById('dramaMeta').innerHTML = `
          ${currentDrama.chapterCount ? `<span class="detail-meta-item">üì∫ ${currentDrama.chapterCount} ${i18n.t('episodes')}</span>` : ''}
          ${currentDrama.genre ? `<span class="detail-meta-item">üé≠ ${currentDrama.genre}</span>` : ''}
          ${currentDrama.year ? `<span class="detail-meta-item">üìÖ ${currentDrama.year}</span>` : ''}
        `;

                episodes = await api.getEpisodes(bookId);
                renderEpisodes();

                const h = watchHistory.get(bookId);
                if (h && h.episodeIndex > 0) {
                    document.getElementById('playBtn').innerHTML = `‚ñ∂Ô∏è ${i18n.t('continueWatch')} ${h.episodeName}`;
                }
            } catch (e) { showError(e.message); }
            hideLoading();
        }

        function renderEpisodes() {
            const grid = document.getElementById('episodeGrid');
            document.getElementById('episodeCount').textContent = `(${episodes.length})`;
            if (!episodes.length) { grid.innerHTML = `<p class="empty-state">${i18n.t('notFound')}</p>`; return; }

            const h = watchHistory.get(currentDrama?.bookId);
            grid.innerHTML = episodes.map((ep, i) => {
                const watched = h && h.episodeIndex > i;
                const current = h && h.episodeIndex === i;
                const progress = (current && h.duration > 0) ? (h.progress / h.duration) * 100 : 0;
                return `
          <div class="episode-card ${watched ? 'watched' : ''} ${current ? 'current' : ''}" onclick="playEp(${i})">
            <div class="episode-thumb">
              <img src="${currentDrama?.coverUrl || ''}" alt="${ep.chapterName}" loading="lazy">
              ${current ? `<div class="episode-progress" style="width:${progress}%"></div>` : ''}
            </div>
            <div class="episode-info">
              <span class="episode-number">${i18n.t('episode')} ${i + 1}</span>
              <span class="episode-name">${ep.chapterName}</span>
            </div>
          </div>
        `;
            }).join('');
        }

        function playFromStart() {
            const h = watchHistory.get(currentDrama?.bookId);
            playEp(h ? h.episodeIndex : 0);
        }

        function playEp(i) {
            if (currentDrama) location.href = `watch?id=${currentDrama.bookId}&ep=${i}`;
        }

        function shareDrama() {
            if (navigator.share) {
                navigator.share({ title: currentDrama?.bookName, text: `‡∏î‡∏π ${currentDrama?.bookName} ‡∏ö‡∏ô DramaBox`, url: location.href });
            } else {
                navigator.clipboard.writeText(location.href);
                Swal.fire({ icon: 'success', title: '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß', background: '#181818', color: '#fff', timer: 1500 });
            }
        }

        function searchFromDetail() {
            const q = document.getElementById('searchInput').value.trim();
            if (q) location.href = `/?search=${encodeURIComponent(q)}`;
        }

        function showLoading() { document.getElementById('loadingOverlay').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('loadingOverlay').classList.add('hidden'); }
        function showError(m) { Swal.fire({ icon: 'error', title: i18n.t('error'), text: m, background: '#181818', color: '#fff', confirmButtonColor: '#e50914' }); }
    </script>
</body>

</html>